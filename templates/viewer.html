{% extends "base.html" %}
{% block head %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="/static/viewer.css">
<script type="text/javascript" src="/static/jquery.js"></script>
<script type="text/javascript">
var words = {{ words|tojson|safe }};
var boardL = {{ board|tojson|safe }};
var mults = {{ mults|tojson|safe }};
var LETTER_VALS = {{ lettervals|tojson|safe }};
board = boardL.toUpperCase();
var wordNum = 0; // index into words

// draw grid and letters
function drawBg(ctx) {
    // grid
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 4;
    ctx.lineCap = 'square';
    ctx.beginPath();
    for (var i = 2; i <= 402; i += 100) {
        ctx.moveTo(2, i);
        ctx.lineTo(402, i);
        ctx.moveTo(i, 2);
        ctx.lineTo(i, 402);

    }
    ctx.stroke();
    ctx.closePath();

    // letters
    ctx.font = '40pt Cantarell';
    ctx.fillStyle = '#000';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    for (i = 0; i < 4; ++i) {
        for (var j = 0; j < 4; ++j) {
            ctx.fillText(board[4*i + j], 52 + 100*j, 54 + 100*i);
        }
    }

    // letter modifiers
    ctx.font = '12pt Cantarell';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    for (i = 0; i < 4; ++i) {
        for (var j = 0; j < 4; ++j) {
            ctx.fillText(mults[4*i + j], 8 + 100*j, 7 + 100*i);
        }
    }

    // letter points
    ctx.textAlign = 'right';
    ctx.textBaseline = 'top';
    for (i = 0; i < 4; ++i) {
        for (var j = 0; j < 4; ++j) {
            ctx.fillText(LETTER_VALS[boardL[4*i + j]], 96 + 100*j, 7 + 100*i);
        }
    }

}

// draw one word and its path and score
function drawWord(ctx) {
    word = words[wordNum];
    path = word.path;
    // draw behind
    ctx.globalCompositeOperation = 'destination-over';
    // green starting square
    ctx.fillStyle = '#00FF00';
    ctx.fillRect(4 + 100 * col(path[0]), 4 + 100 * row(path[0]), 96, 96);
    // red ending square
    ctx.fillStyle = '#FF0000';
    ctx.fillRect(4 + 100 * col(path[path.length - 1]), 4 + 100 * row(path[path.length - 1]), 96, 96);
    // restore gCO
    ctx.globalCompositeOperation = 'source-over';

    // draw path
    ctx.lineCap = 'round';
    ctx.lineWidth = 8;
    ctx.beginPath();
    for (var i = 0; i < path.length - 1; ++i) {
        from = path[i];
        to = path[i + 1];
        ctx.moveTo(52 + 100 * col(from), 52 + 100 * row(from));
        ctx.lineTo(52 + 100 * col(to), 52 + 100 * row(to));
    }
    ctx.stroke();
    ctx.closePath();
    
    // draw word info
    ctx.font = '40pt Cantarell';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#000';
    ctx.fillText(word.word.toUpperCase() + ' ' + word.score, 200, 460);
    $('#wordNum').text(wordNum + 1);
}

function row(i) {
    return ~~(i / 4);
}

function col(i) {
    return i % 4;
}

function redraw(ctx) {
    ctx.clearRect(0,0,404,550);
    drawBg(ctx);
    drawWord(ctx);
}


$(function() {
    var canvas = document.getElementById('viewer');
    var ctx = canvas.getContext('2d');

    redraw(ctx);

    $(document).keydown(function(e) {
        if (e.keyCode == 37 && wordNum > 0) {
        --wordNum;
        redraw(ctx);
        } else if ((e.keyCode == 39 || e.keyCode == 32) && wordNum < words.length - 1) {
        ++wordNum;
        redraw(ctx);
        } else if (e.keyCode == 48) {
        wordNum = 0;
        redraw(ctx);
        } else if (e.keyCode == 71 && e.shiftKey) {
        wordNum = words.length - 1;
        redraw(ctx);
        }
    });

});

</script>
{% endblock %}
{% block content %}
<div class="column" id="center">
<canvas id="viewer" width="404px" height="550px">
    Oh no, your browser doesn't support canvas!
</canvas>
</div>

<div class="column" id="left">
    <div id="controls">
        <ul>
            <li>Space/Right: Next word
            <li>Left: Previous word
            <li><span class="mono">0</span>: First word
            <li><span class="mono">G</span>: Last word
        </ul>
    </div>
</div>

<div class="column" id="right">
    <div id="stats">
        Word: <span id="wordNum">1</span>/{{ words|length }}
    </div>
</div>
{% endblock %}
